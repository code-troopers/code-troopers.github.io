
<!doctype html >
<html class="no-js" lang="fr-fr" itemscope itemtype="http://schema.org/Organization">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> Installer votre dépot privé Docker &middot;  Code-Troopers - Vous avez une idée, nous la réalisons</title>
  <meta property="fb:app_id" content="432735746865877"/>

  <meta property="og:title" content=" Installer votre dépot privé Docker &middot;  Code-Troopers - Vous avez une idée, nous la réalisons" />
  <meta property="og:site_name" content="Code-Troopers - Vous avez une idée, nous la réalisons" />
  <meta property="og:url" content="https://code-troopers.com/2015/06/25/installdockerregistry/" />
  <meta property="og:image" content="https://code-troopers.com//images/banner/logo-banner.png"/>

  
  <meta property="og:type" content="article" />
  <meta property="og:article:published_time" content="2015-06-25T00:00:00Z" />
  <meta property="og:article:tag" content="guide" />
  <meta property="og:article:tag" content="docker" />
  <meta property="og:article:tag" content="tips" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@codetroopers" />
  <meta name="twitter:creator" content="@codetroopers" />
  <meta name="twitter:title" content="Installer votre dépot privé Docker" />
  <meta name="twitter:url" content="https://code-troopers.com/2015/06/25/installdockerregistry/" />

  
  <meta name="twitter:description" content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser). En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe." />
  <meta name="twitter:image" content="https://code-troopers.com//images/banner/docker-banner.png" />
  <meta name="description" content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser). En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe." />
  <meta property="og:description" content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser). En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe."/>
  

  <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  
  

  
  <link href="https://code-troopers.com/index.xml" rel="alternate" type="application/rss+xml" title="Code-Troopers - Vous avez une idée, nous la réalisons" />
  

  
  <link rel="canonical" href="https://code-troopers.com/2015/06/25/installdockerregistry/" />

  
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Installer votre dépot privé Docker",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/?rel=author"
    },
    "datePublished": "2015-06-25",
    "description": "",
    "wordCount":  572 
  }
  </script>
  

  <link href="/css/style-0b06b9a2ff.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  
  <meta itemprop="name" content="CT-CDGT"/>
  <meta itemprop="name" content="CT-RMLC"/>
  <meta itemprop="name" content="CT-BNCS"/>
  <meta itemprop="name" content="CT-JRPT"/>
  <meta itemprop="name" content="CT-MTBL"/>
  <meta itemprop="name" content="CT-FLCH"/>
  <meta itemprop="name" content="CT-VCMB"/>

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
</head>
<body>
  
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NWLQD2"
                height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NWLQD2');</script>
        
        
  <header data-spy="affix" class="affix-top">
    <div class="container">
        <div class="navbar-header" itemscope itemtype="http://schema.org/Organization">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span><i class="fa fa-bars fa-2x"></i></span>
            </button>
            <a itemprop="url" class="navbar-brand" href="/"><img itemprop="logo" class="logo" alt="Code-Troopers logo" title="Code-Troopers logo" src="/images/logo.png">
                <span itemprop="name" class="brand">Code-Troopers</span>
            </a>
        </div>
        <nav class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a data-scrollToLink="aboutUs">À propos</a></li>
                <li><a data-scrollToLink="projects">Réalisations</a></li>
                <li><a data-scrollToLink="skills">Compétences</a></li>
                <li><a data-scrollToLink="team">L'équipe</a></li>
                <li><a data-scrollToLink="contact">Contact</a></li>
                <li><a href="/blog/">Blog</a></li>
            </ul>
        </nav>
        
    </div>
</header>


<section>
<div class="header">
  <h1 class="container">
    <a href="/blog/index.html">Le <span>blog</span></a>
  </h1>
</div>
</section>

<section id="post">
        <div class="container">
        <article>
            <div>
		<div class="cover" style="background-image:url(/images/banner/docker-banner-big.png)">
                    
                    <div class="date">par Cedric</div>
                </div>
                <h2><a href="https://code-troopers.com/2015/06/25/installdockerregistry/">Installer votre dépot privé Docker</a></h2>
                <span class="label label-info">~3 minute(s) à lire</span>
                
                <ul class="tags">
                
                    <li><a style="color:white;border-color: white" href="https://code-troopers.com//tags/guide/">guide</a></li>
                
                    <li><a style="color:white;border-color: white" href="https://code-troopers.com//tags/docker/">docker</a></li>
                
                    <li><a style="color:white;border-color: white" href="https://code-troopers.com//tags/tips/">tips</a></li>
                
                </ul>
                
                <div class="content">
                    	

<p>Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker.
Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser).</p>

<p>En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public.
Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe.</p>

<p>La procédure n&rsquo;est pas très complexe, mais cette opération reste une bonne opportunité d&rsquo;écrire un article à ce sujet (les articles en français n&rsquo;étant pas légion).</p>

<h2 id="step-by-step:5ccf6384c70e5ed97658dbf0e91e8805">Step by step</h2>

<p>Il faut créer une entrée DNS pour votre service.</p>

<p>Puis nous allons utiliser l&rsquo;image Docker avec nginx pour l&rsquo;authentification <a href="https://github.com/MarvAmBass/docker-nginx-registry-proxy">docker-nginx-registry-proxy</a>.</p>

<h2 id="informations-d-identification:5ccf6384c70e5ed97658dbf0e91e8805">Informations d&rsquo;identification</h2>

<p>Pour les étapes suivantes, placez vous dans le répertoire de votre choix pour stocker les fichiers (dans ce cas nous sommes dans <code>/srv/registry-config</code>)</p>

<h3 id="génération-du-certificat:5ccf6384c70e5ed97658dbf0e91e8805">Génération du certificat</h3>

<p>Pensez à bien renseigner le FQDN DNS lors de la demande de Common Name pour le certificat.</p>

<pre><code>openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 1826 -key ca.key -out ca.crt
openssl genrsa -out ia.key 4096
openssl req -new -key key.pem -out ia.csr #this is where you need to fill your FQDN
openssl x509 -req -days 730 -in ia.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out cert.pem
</code></pre>

<h3 id="génération-des-mots-de-passes-basic-auth:5ccf6384c70e5ed97658dbf0e91e8805">Génération des mots de passes basic auth</h3>

<p>En utilisant un container docker qui embarque htpasswd vous pourrez générer facilement le fichier nécessaire :</p>

<pre><code>docker run --rm -ti -v $(pwd):/tmp dgageot/htpasswd -c /tmp/docker-registry.htpasswd $MONUSER
</code></pre>

<h2 id="démarrage-du-registry:5ccf6384c70e5ed97658dbf0e91e8805">Démarrage du registry</h2>

<p>Les images seront stockées dans le répertoire <code>/srv/registry</code></p>

<pre><code>mkdir /srv/registry
docker run -d --restart=always --name registry -v /srv/docker-registry:/registry -e &quot;SETTINGS_FLAVOR=local&quot; -e &quot;STORAGE_PATH=/registry&quot; registry
docker run -d --restart=always -p 443:443 -v /srv/registry-config:/etc/nginx/external --link registry:registry --name nginx-registry-proxy marvambass/nginx-registry-proxy
</code></pre>

<h2 id="configuration-d-une-machine-cliente:5ccf6384c70e5ed97658dbf0e91e8805">Configuration d&rsquo;une machine cliente</h2>

<h3 id="importer-le-certificat-racine:5ccf6384c70e5ed97658dbf0e91e8805">Importer le certificat racine</h3>

<p>Il faut importer le certificat racine dans la liste des certificats reconnus</p>

<pre><code>sudo -s
mkdir -p /etc/docker/certs.d/$FQDN
cp ca.crt /etc/docker/certs.d/$FQDN/

mkdir -p /usr/local/share/ca-certificates/docker-ct
cp ca.crt /usr/local/share/ca-certificates/docker-ct/
update-ca-certificates-
</code></pre>

<p>Pour vérifier que tout fonctionne comme attendu, vous pouvez voir si votre certificat ressort bien dans la commande suivante :</p>

<pre><code>awk -v cmd='openssl x509 -noout -subject' ' /BEGIN/{close(cmd)};{print | cmd}' &lt; /etc/ssl/certs/ca-certificates.crt | grep $(VOTRE IDENTIFIANT)
</code></pre>

<p>Vous serez également certainement amené à redémarrer vos daemon docker (de chacune des machines)</p>

<pre><code>systemctl stop docker
systemctl start docker
</code></pre>

<h3 id="identification-sur-le-dépot:5ccf6384c70e5ed97658dbf0e91e8805">Identification sur le dépot</h3>

<p>Une fois que toutes ces étapes sont effectuées, normalement votre dépot est prêt à être utilisé.</p>

<p>Il vous faut cependant en première étape vous identifier à l&rsquo;aide du couple utilisateur / mot de passe créé lors de l&rsquo;installation :</p>

<pre><code>docker login https://mondepotdocker.tld
</code></pre>

<p>Ceci aura pour effet de créer un fichier <code>~/.dockercfg</code> vous permettant d&rsquo;accéder aux commandes suivantes sans avoir besoin de retaper vos identifiants.</p>

<h2 id="utilisation-du-dépôt:5ccf6384c70e5ed97658dbf0e91e8805">Utilisation du dépôt</h2>

<p>Une fois la machine cliente configurée, vous pouvez simplement utiliser le dépot en préfixant les noms de vos images par l&rsquo;URL du dépôt.
Par exemple, pour push/pull l&rsquo;image de monapplication la commande suivante fera l&rsquo;affaire :</p>

<pre><code>docker push mondepotdocker.tld/monapplication:v1.0.0
docker pull mondepotdocker.tld/monapplication:v1.0.0
</code></pre>

<h3 id="utilisation-avec-docker-compose:5ccf6384c70e5ed97658dbf0e91e8805">Utilisation avec docker-compose</h3>

<p>Si vous utilisez docker-compose, il se peut que vous ayiez des soucis avec le certificat autosigné et/ou avec l&rsquo;authentification.</p>

<p>Pour contourner la vérification du certificat, vous pouvez simplement lancer <code>docker-compose</code> avec le flag <code>--allow-insecure-ssl</code>.</p>

<p>Pour ce qui est de l&rsquo;authentification, une astuce simple pour contourner les problèmes de ce genre est de faire un <code>docker pull</code> manuellement au préalable (le scripter depuis le fichier compose.yml n&rsquo;est pas trop difficile).</p>

                </div>
<div class="share">
L'article vous a plu ? Partagez-le :
    <ul class="socials">
        <li>
            <a target="_blank" title="Twitter" href="https://twitter.com/share?url=http://code-troopers.comhttps%3a%2f%2fcode-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&text=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker&via=codetroopers"
                rel="nofollow"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                <i class="fa fa-twitter-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Facebook" href="https://www.facebook.com/sharer.php?u=http://code-troopers.comhttps%3a%2f%2fcode-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&t=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker"
                class="facebook-button" rel="nofollow"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                <i class="fa fa-facebook-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Google +" href="https://plus.google.com/share?url=http://code-troopers.comhttps%3a%2f%2fcode-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&hl=fr"
                class="google-button" rel="nofollow"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-google-plus-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://code-troopers.comhttps%3a%2f%2fcode-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&title=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker"
                class="linkedin-button" rel="nofollow"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-linkedin-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Envoyer par mail" href="mailto:?subject=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker&body=http://code-troopers.comhttps%3a%2f%2fcode-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f" rel="nofollow">
                <i class="fa fa-envelope"></i>
            </a>
        </li>
    </ul>
</div>
<div style="clear:both"></div>



                <div class="back">
                    <a href="/"><i class="fa fa-arrow-circle-o-up"></i> Retour aux articles</a>
                    <div class="pull-right paginate">
                        
                        <a href="https://code-troopers.com/2015/06/10/completionjavascriptdansintellij/"><i class="fa fa-arrow-circle-o-left"></i> Précédent</a>
                        
                        
                        <a href="https://code-troopers.com/2015/07/16/gitsvn/"><i class="fa fa-arrow-circle-o-right"></i> Suivant</a>
                        
                    </div>
                </div>

                <section id="menu">
                    <ul>
                        
                    </ul>
                </section>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                     
                    var disqus_shortname = 'codetroopers'; 
		    var disqus_url = window.location.href;
		    if (window.location.protocol != "http:"){
			disqus_url = "http:" + window.location.href.substring(window.location.protocol.length);
		    }

                     
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </article>
        </div>
    </section>
<footer id="contact">
    <div class="container">
        <div class="row">
            <div class="col-md-6" itemscope itemtype="http://schema.org/Organization">
                <h3>Contact</h3>

                <p>Vous avez besoin de nous pour un projet, contactez-nous sur les réseaux sociaux, par mail à <a
                    href="mailto:contact@code-troopers.com"><meta itemprop="email" content="contact@code-troopers.com">contact@code-
                    troopers.com</a></p>
            </div>
            <div class="col-md-6 simple-social-icons">
                <h3>Réseaux sociaux</h3>
                <ul class="socials">
                    <li><a target="_blank" href="https://twitter.com/codetroopers"><i
                            class="fa fa-twitter-square"></i></a></li>
                    <li><a target="_blank"
                           href="https://www.facebook.com/pages/Code-Troopers/123604307824664"><i
                            class="fa fa-facebook-square"></i></a></li>
                    <li><a target="_blank" href="https://plus.google.com/+Code-troopers" rel="publisher"><i
                            class="fa fa-google-plus-square"></i></a></li>
                    <li><a target="_blank" href="https://github.com/code-troopers"><i
                            class="fa fa-github-square"></i></a></li>
                    <li><a target="_blank" href="/feed.xml"><i
                            class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="footer-under">
                Made with <i class="fa fa-heart"></i> in Tours -
              © 2016 Code-Troopers - Tous droits réservés
            </div>
						<div class="legals footer-under">
							  Mentions légales : <br>
							  Code-Troopers est une  marque déposée à l'INPI (numéro 4145181).<br>
								CT-CDGT SARL au capital de 1000€, 73 rue Ledru Rollin, 37000 Tours, 808 881 064 RCS Tours. <br>
								Site hébergé par GitHub Inc.
						</div>
        </div>
    </div>
</footer>
<script src="/js/scripts-aa72765cff.js"></script>
</body>

