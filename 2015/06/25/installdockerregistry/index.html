<!doctype html>
<html lang="fr">
  <head>
  <title>Code-Troopers - Installer votre dépot privé Docker</title>
  <meta name="description" content="">

  
  
    <link href="/main.0bfd2.css" rel="stylesheet">
  
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <base href="/">
	
	<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
	<link rel="icon" href="/favicon.png">
	<link rel="manifest" href="/manifest.json">
	<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#ff4400">
	<meta name="theme-color" content="#fff">

  
  <meta property="og:title" content="Installer votre dépot privé Docker" />
<meta property="og:description" content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser).
En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2015/06/25/installdockerregistry/" /><meta property="og:image" content="/img/logo-code-troopers-t%C3%AAte-couleur.png" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2015-06-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-06-25T00:00:00+00:00" />



  
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
  <body class="sans-serif">

    <header>
    <nav>
        
            <a id="id-company" href="/"><span>Code-Troopers</span></a>
        
            <a id="id-skills" href="#skills"><span>Compétences</span></a>
        
            <a id="id-portfolio" href="#portfolio"><span>Réalisations</span></a>
        
            <a id="id-casting" href="https://team.code-troopers.com"><span>L&#39;équipe</span></a>
        
            <a id="id-blogs" href="/blog"><span>Blog</span></a>
        
            <a id="id-contact" href="#contact"><span>Contact</span></a>
        
    </nav>
</header>

    

<section id="blog">
    <div class="wrapper">
        <h1>
            Blog
        </h1>
    </div>

    <section id="article">
        <div class="wrapper">
            <article>
                
                    
                        <img src="/2015/06/25/installdockerregistry/docker-banner_huab693ed69fbd272a6c085a178e7b48b1_644680_900x500_fill_q100_h2_box_center_3.webp" width="900" height="500" alt="">
                    
                
                <div class="wrapper-content">
                    <h2>Installer votre dépot privé Docker</h2>
                    
                    <ul class="tags">
                        
                        <li><a href="/tags/guide/">guide</a></li>
                        
                        <li><a href="/tags/docker/">docker</a></li>
                        
                        <li><a href="/tags/tips/">tips</a></li>
                        
                    </ul>
                    
                    <div class="content">
                        <p>Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker.
Cela fait quelque temps que nous l&rsquo;utilisons pour des projets &ldquo;public&rdquo;, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser).</p>
<p>En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public.
Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe.</p>
<p>La procédure n&rsquo;est pas très complexe, mais cette opération reste une bonne opportunité d&rsquo;écrire un article à ce sujet (les articles en français n&rsquo;étant pas légion).</p>
<h2 id="step-by-step">Step by step</h2>
<p>Il faut créer une entrée DNS pour votre service.</p>
<p>Puis nous allons utiliser l&rsquo;image Docker avec nginx pour l&rsquo;authentification <a href="https://github.com/MarvAmBass/docker-nginx-registry-proxy">docker-nginx-registry-proxy</a>.</p>
<h2 id="informations-didentification">Informations d&rsquo;identification</h2>
<p>Pour les étapes suivantes, placez vous dans le répertoire de votre choix pour stocker les fichiers (dans ce cas nous sommes dans <code>/srv/registry-config</code>)</p>
<h3 id="génération-du-certificat">Génération du certificat</h3>
<p>Pensez à bien renseigner le FQDN DNS lors de la demande de Common Name pour le certificat.</p>
<pre><code>openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 1826 -key ca.key -out ca.crt
openssl genrsa -out ia.key 4096
openssl req -new -key key.pem -out ia.csr #this is where you need to fill your FQDN
openssl x509 -req -days 730 -in ia.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out cert.pem
</code></pre>
<h3 id="génération-des-mots-de-passes-basic-auth">Génération des mots de passes basic auth</h3>
<p>En utilisant un container docker qui embarque htpasswd vous pourrez générer facilement le fichier nécessaire :</p>
<pre><code>docker run --rm -ti -v $(pwd):/tmp dgageot/htpasswd -c /tmp/docker-registry.htpasswd $MONUSER
</code></pre>
<h2 id="démarrage-du-registry">Démarrage du registry</h2>
<p>Les images seront stockées dans le répertoire <code>/srv/registry</code></p>
<pre><code>mkdir /srv/registry
docker run -d --restart=always --name registry -v /srv/docker-registry:/registry -e &quot;SETTINGS_FLAVOR=local&quot; -e &quot;STORAGE_PATH=/registry&quot; registry
docker run -d --restart=always -p 443:443 -v /srv/registry-config:/etc/nginx/external --link registry:registry --name nginx-registry-proxy marvambass/nginx-registry-proxy
</code></pre>
<h2 id="configuration-dune-machine-cliente">Configuration d&rsquo;une machine cliente</h2>
<h3 id="importer-le-certificat-racine">Importer le certificat racine</h3>
<p>Il faut importer le certificat racine dans la liste des certificats reconnus</p>
<pre><code>sudo -s
mkdir -p /etc/docker/certs.d/$FQDN
cp ca.crt /etc/docker/certs.d/$FQDN/

mkdir -p /usr/local/share/ca-certificates/docker-ct
cp ca.crt /usr/local/share/ca-certificates/docker-ct/
update-ca-certificates-
</code></pre>
<p>Pour vérifier que tout fonctionne comme attendu, vous pouvez voir si votre certificat ressort bien dans la commande suivante :</p>
<pre><code>awk -v cmd='openssl x509 -noout -subject' ' /BEGIN/{close(cmd)};{print | cmd}' &lt; /etc/ssl/certs/ca-certificates.crt | grep $(VOTRE IDENTIFIANT)
</code></pre>
<p>Vous serez également certainement amené à redémarrer vos daemon docker (de chacune des machines)</p>
<pre><code>systemctl stop docker
systemctl start docker
</code></pre>
<h3 id="identification-sur-le-dépot">Identification sur le dépot</h3>
<p>Une fois que toutes ces étapes sont effectuées, normalement votre dépot est prêt à être utilisé.</p>
<p>Il vous faut cependant en première étape vous identifier à l&rsquo;aide du couple utilisateur / mot de passe créé lors de l&rsquo;installation :</p>
<pre><code>docker login https://mondepotdocker.tld
</code></pre>
<p>Ceci aura pour effet de créer un fichier <code>~/.dockercfg</code> vous permettant d&rsquo;accéder aux commandes suivantes sans avoir besoin de retaper vos identifiants.</p>
<h2 id="utilisation-du-dépôt">Utilisation du dépôt</h2>
<p>Une fois la machine cliente configurée, vous pouvez simplement utiliser le dépot en préfixant les noms de vos images par l&rsquo;URL du dépôt.
Par exemple, pour push/pull l&rsquo;image de monapplication la commande suivante fera l&rsquo;affaire :</p>
<pre><code>docker push mondepotdocker.tld/monapplication:v1.0.0
docker pull mondepotdocker.tld/monapplication:v1.0.0
</code></pre>
<h3 id="utilisation-avec-docker-compose">Utilisation avec docker-compose</h3>
<p>Si vous utilisez docker-compose, il se peut que vous ayiez des soucis avec le certificat autosigné et/ou avec l&rsquo;authentification.</p>
<p>Pour contourner la vérification du certificat, vous pouvez simplement lancer <code>docker-compose</code> avec le flag <code>--allow-insecure-ssl</code>.</p>
<p>Pour ce qui est de l&rsquo;authentification, une astuce simple pour contourner les problèmes de ce genre est de faire un <code>docker pull</code> manuellement au préalable (le scripter depuis le fichier compose.yml n&rsquo;est pas trop difficile).</p>

                    </div>
                    <div class="content-footer">
                        
                        <ul class="tags float">
                            
                            <li><a href="/tags/guide/">guide</a></li>
                            
                            <li><a href="/tags/docker/">docker</a></li>
                            
                            <li><a href="/tags/tips/">tips</a></li>
                            
                        </ul>
                        
                        <section id="author">
                            <div class="date">Rédigé par <span class="author-name">Cedric</span></div>
                        </section>
                    </div>
                    <div class="share">
                        <span>Partager</span>
                        <ul class="socials">
                            <li>
                                <a target="_blank" title="Facebook"
                                    href="https://www.facebook.com/sharer.php?u=http://code-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&t=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker"
                                    class="facebook-button" rel="nofollow"
                                    onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                                    <svg class="icon-svg facebook-fill-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 13.5H16.5L17.5 9.5H14V7.5C14 6.47062 14 5.5 16 5.5H17.5V2.1401C17.1743 2.09685 15.943 2 14.6429 2C11.9284 2 10 3.65686 10 6.69971V9.5H7V13.5H10V22H14V13.5Z"></path></svg>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Twitter"
                                    href="https://twitter.com/share?url=http://code-troopers.com%2f2015%2f06%2f25%2finstalldockerregistry%2f&text=Installer%20votre%20d%c3%a9pot%20priv%c3%a9%20Docker&via=codetroopers"
                                    rel="nofollow"
                                    onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                                    <svg class="icon-svg twitter-x-fill-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.2048 2.25H21.5128L14.2858 10.51L22.7878 21.75H16.1308L10.9168 14.933L4.95084 21.75H1.64084L9.37084 12.915L1.21484 2.25H8.04084L12.7538 8.481L18.2048 2.25ZM17.0438 19.77H18.8768L7.04484 4.126H5.07784L17.0438 19.77Z"></path></svg>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div style="clear:both"></div>


                    <div class="back">
                        <div class="pagination">
                            
                            <a href="/2015/07/16/gitsvn/" class="previous-page">
                                <div class="arrow"><div class="arrow_box_left arrow_box">
</div></div>
                                Article précédent
                            </a>
                            
                            
                            <a href="/2015/06/10/completionjavascriptdansintellij/" class="next-page">
                                Article suivant
                                <div class="arrow"><div class="arrow_box_right arrow_box">
</div></div>
                            </a>
                            
                        </div>
                    </div>

                    <section id="menu">
                        <ul>
                            
                        </ul>
                    </section>

                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                         
                        var disqus_shortname = 'codetroopers' 
                        var disqus_url = window.location.href
                        if (window.location.protocol != 'http:') {
                            disqus_url = 'http:' + window.location.href.substring(window.location.protocol.length)
                        }

                         
                        (function () {
                            var dsq = document.createElement('script')
                            dsq.type = 'text/javascript'
                            dsq.async = true
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
                        })()
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                            powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span
                            class="logo-disqus">Disqus</span></a>
                </div>
            </article>
        </div>
    </section>
</section>


    <section id="contact">
    <h1>Contact</h1>
    <div>
        <div>
            <img class="cover" loading="lazy" src="/img/legos_contact.webp" alt="legos" width="100%" height="100%">
        </div>
        <div>
            <h2>Code-Troopers</h2>
            <p>
                26 bis rue Abraham Bosse<br>
                37000 Tours - Fr
            </p>
            <p>
                <a href="mailto:contact@code-troopers.com">contact@code-troopers.com</a>
            </p>
            <p>
                <a class="button" href="tel:+33782287216">07 82 28 72 16</a>
            </p>
        </div>
    </div>

    <h1>Suivez nos actualités</h1>

    <ul class="flex x3">
        <li>
            <a aria-label="Facebook Code-Troopers" href="https://facebook.com/codetroopers37">
                <svg class="icon-svg facebook-fill-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 13.5H16.5L17.5 9.5H14V7.5C14 6.47062 14 5.5 16 5.5H17.5V2.1401C17.1743 2.09685 15.943 2 14.6429 2C11.9284 2 10 3.65686 10 6.69971V9.5H7V13.5H10V22H14V13.5Z"></path></svg>
            </a>
        </li>
        <li>
            <a aria-label="Twitter Code-Troopers" href="https://twitter.com/codetroopers">
                <svg class="icon-svg twitter-x-fill-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.2048 2.25H21.5128L14.2858 10.51L22.7878 21.75H16.1308L10.9168 14.933L4.95084 21.75H1.64084L9.37084 12.915L1.21484 2.25H8.04084L12.7538 8.481L18.2048 2.25ZM17.0438 19.77H18.8768L7.04484 4.126H5.07784L17.0438 19.77Z"></path></svg>
            </a>
        </li>
        <li>
            <a aria-label="Github Code-Troopers" href="https://github.com/code-troopers">
                <svg class="icon-svg github-fill-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"></path></svg>
            </a>
        </li>
    </ul>
</section>

<footer>
    <div class="wrapper">
        <a href="#top" class="scroll-to-top" title="Retourner en haut de la page">
            <img class="arrow" loading="lazy" src="/img/arrow.webp" alt="arrow icon">
        </a>
        <img src="/img/footer_logo.webp" alt="logo Code-Troopers">
        <div>
            <span>©2014 — 2024 Code-Troopers | <a href="/legals.html">Mentions légales</a></span>
            <span>Design : <a href="https://www.descheval.com/">descheval.com</a> | Développement : Code-Troopers</span>
        </div>
    </div>
</footer>

    
    
      <script src="/main.0bfd2.js"></script>
    
  </body>
</html>
