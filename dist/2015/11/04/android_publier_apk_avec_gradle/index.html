<!doctype html>
<html lang="fr">
  <head>
  <title>Code-Troopers - Android : Publier son apk en ligne de commande</title>
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
/>

  
  
    <link href="/main.css" rel="stylesheet">
  
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <base href="/">
	
	<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
	<link rel="icon" href="/favicon.ico">
	<link rel="manifest" href="/manifest.json">
	<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#ff4400">
	<meta name="theme-color" content="#fff">

  
  <meta property="og:title" content="Android : Publier son apk en ligne de commande" />
<meta property="og:description" content="Lorsque l’on fait du développement Android, on a régulièrement besoin de publier des nouvelles versions de l&rsquo;application sur le Play Store. Il est assez fastidieux de devoir se connecter à l’interface de Google, de sélectionner le projet et ensuite d’uploader son nouvel apk.
Heureusement pour nous, Google a prévu le coup avec une API que l’on peut attaquer en ligne de commande. Et, encore plus sympa, Björn Hurling a publié sur github un plugin gradle qui utilise cette API." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2015/11/04/android_publier_apk_avec_gradle/" /><meta property="og:image" content="/img/gopher_moi.png"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2015-11-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-11-04T00:00:00+00:00" />


  
</head>
  <body class="sans-serif">

    <header>
    <nav>
        
            <a id="id-company" href="/">Code-Troopers</a>
        
            <a id="id-skills" href="#skills">Compétences</a>
        
            <a id="id-portfolio" href="#portfolio">Réalisations</a>
        
            <a id="id-casting" href="https://team.code-troopers.com">L&#39;équipe</a>
        
            <a id="id-blogs" href="/blog">Blog</a>
        
            <a id="id-contact" href="#contact">Contact</a>
        
    </nav>
</header>

    

<section id="blog">
    <div class="wrapper">
        <h1>
            Blog
        </h1>
    </div>

    <section id="article">
        <div class="wrapper">
            <article>
                
                <img src="/blog/../android-banner.png">
                
                
                
                
                <div class="wrapper-content">
                    <h2>Android : Publier son apk en ligne de commande</h2>
                    
                    
                    <ul class="tags">
                        
                        <li><a href="/tags/android/">Android</a></li>
                        
                        <li><a href="/tags/apk/">APK</a></li>
                        
                        <li><a href="/tags/gradle/">Gradle</a></li>
                        
                        <li><a href="/tags/livraison/">Livraison</a></li>
                        
                    </ul>
                    
                    <div class="content">
                        <p>Lorsque l’on fait du développement Android, on a régulièrement besoin de publier des nouvelles versions de l&rsquo;application sur le Play Store.
Il est assez fastidieux de devoir se connecter à l’interface de Google, de sélectionner le projet et ensuite d’uploader son nouvel apk.</p>
<p>Heureusement pour nous, Google a prévu le coup avec une API que l’on peut attaquer en ligne de commande.
Et, encore plus sympa, <a href="https://plus.google.com/+Bj%C3%B6rnHurling/posts">Björn Hurling</a> a publié sur github
<a href="https://github.com/Triple-T/gradle-play-publisher">un plugin gradle qui utilise cette API</a>.</p>
<p>Voyons ensemble pas à pas comment et quoi configurer afin de livrer ses apk en ligne de commande en utilisant gradle.</p>
<h2 id="prérequis">Prérequis</h2>
<p>Pour commencer, il faut avoir un build qui fonctionne avec gradle.</p>
<p>Normalement pas de problème si c&rsquo;est un projet récent puisque c&rsquo;est ce qu&rsquo;Android Studio propose maintenant par défaut.
Si ce n&rsquo;est pas le cas, vous pouvez vous reposer sur la <a href="http://tools.android.com/tech-docs/new-build-system/intellij_to_gradle">doc de Google</a> à ce sujet.</p>
<h2 id="étape-1--création-du-service-account">Étape 1 : Création du &lsquo;Service Account&rsquo;</h2>
<p>La première étape consiste à créer un compte qui peut utilser l&rsquo;API de Google : contrairement à un compte utilisateur classique, celui-ci utilisera un ficher de clé pour s&rsquo;identifier plutôt qu&rsquo;un mot de passe.</p>
<p>Pour cela, rendez-vous dans un premier temps dans l&rsquo;interface développeur du Play Store, dans la section <code>Settings &gt; API acces</code> et cliquez sur <code>Create Service Account</code>.</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen1.png" data-lightbox="group-1" title="Configuration de l'Accout service - 1" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen1.png" alt="Configuration de l'Accout service - 1"/>
  </a>
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen2.png" data-lightbox="group-1" title="Configuration de l'Accout service - 2" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen2.png" alt="Configuration de l'Accout service - 2"/>
  </a>
</div>
<p>En suivant le lien du petit <code>1</code> vous allez être redirigé vers la console Google développeur d&rsquo;où vous pourrez créer un nouveau <code>Credential</code>  de type <code>Service account</code>.</p>
<p>Sélectionnez le format de clé <code>JSON</code> qui est recommandé, le téléchargement de celle-ci devrait alors se faire automatiquement.</p>
<p>On peut ensuite voir qu&rsquo;un nouveau <code>Service account</code> est apparu dans la liste des Credentials.</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen3.png" data-lightbox="group-1" title="Configuration de l'Accout service - 3" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen3.png" alt="Configuration de l'Accout service - 3"/>
  </a>
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen4.png" data-lightbox="group-1" title="Configuration de l'Accout service - 4" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen4.png" alt="Configuration de l'Accout service - 4"/>
  </a>
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen5.png" data-lightbox="group-1" title="Configuration de l'Accout service - 5" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen5.png" alt="Configuration de l'Accout service - 5"/>
  </a>
</div>
<p>De retour sur l&rsquo;interface d&rsquo;admin du Play Store, on constate que le <code>Service Account</code> est bien créé et disponible ici.</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen6.png" data-lightbox="group-1" title="Configuration de l'Accout service - 6" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen6.png" alt="Configuration de l'Accout service - 6"/>
  </a>
</div>
<h2 id="étape-2--attribution-des-droits">Étape 2 : Attribution des droits</h2>
<p>Il faut maintenant donner les droits au compte que l&rsquo;on vient de créer afin qu&rsquo;il puisse au moins livrer les apk en alpha.</p>
<p>Pour cela cliquez sur le bouton <code>Grant access</code>. Dans la popup qui s&rsquo;ouvre, les droits minimums à accorder pour que le plugin puisse fonctionnner sont :</p>
<ul>
<li>Edit store listing, pricing &amp; distribution</li>
<li>Manage Production APKs</li>
<li>Manage Alpha &amp; Beta APKs</li>
<li>Manage Alpha &amp; Beta users</li>
</ul>
<p>Ces choix pourront être modifés ultérieurement dans l&rsquo;écran récapitulatif (mais ce n&rsquo;est pas recommandé).</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen7.png" data-lightbox="group-1" title="Configuration de l'Accout service - 7" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen7.png" alt="Configuration de l'Accout service - 7"/>
  </a>
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen8.png" data-lightbox="group-1" title="Configuration de l'Accout service - 8" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_ConfigureAccount_Screen8.png" alt="Configuration de l'Accout service - 8"/>
  </a>
</div>
<h2 id="étape-3--le-plugin-gradle">Étape 3 : le plugin gradle</h2>
<p>Il faut maintenant configurer son build pour ajouter les informations relatives au plugin qui effectuera la livraison vers le Play Store.</p>
<p>Dans le fichier <code>build.gradle</code> du projet il faut donc rajouter la dépendance au plugin :</p>
<pre><code>buildscript {

    repositories {
        mavenCentral()
    }

    dependencies {
        // ...
        classpath 'com.github.triplet.gradle:play-publisher:1.1.4'
    }
}
</code></pre>
<p>Et dans le <code>build.gradle</code> de l&rsquo;application (du Module), il faut appliquer le plugin au même niveau que le plugin Android :</p>
<pre><code>apply plugin: 'com.android.application'
apply plugin: 'com.github.triplet.play'
</code></pre>
<p>Ensuite, toujours dans le <code>build.gradle</code>, il est nécessaire d&rsquo;ajouter les informations de l&rsquo;<code>Account service</code> précédemment créé pour qu&rsquo;il puisse se connecter et faire la livraison
(c&rsquo;est là que l&rsquo;on va utiliser la clé <code>JSON</code> générée).</p>
<p>Placez donc la clé dans votre projet et faites-y référence dans la configuration du plugin :</p>
<pre><code>play {
    jsonFile = file('../publishKey/serviceAccountKeys.json')
}
</code></pre>
<p>À partir de là, notre build est configuré. On peut notamment s&rsquo;en rendre compte en faisant un <code>./gradlew tasks</code></p>
<p>On y voit toutes les tâches gradle qu&rsquo;on peut appeler :</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_before.png" data-lightbox="group-1" title="Liste des tasks gradle disponibles sans le plugin" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_before.png" alt="Liste des tasks gradle disponibles sans le plugin"/>
  </a>
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_after.png" data-lightbox="group-1" title="Liste des tasks gradle disponibles avec le plugin" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_after.png" alt="Liste des tasks gradle disponibles avec le plugin"/>
  </a>
</div>
<p>Mais ce n&rsquo;est pas suffisant car il manque notamment les tâches permettant l&rsquo;upload de l&rsquo;apk. Pour cela il faut rajouter la <code>signingConfigs</code> dans le <code>build.gradle</code>.
Ce qui peut notamment se faire comme ça :</p>
<pre><code>    signingConfigs {
        release {
            storeFile file(&quot;../keystore.jks&quot;)
            storePassword &quot;7r00p3r5&quot;
            keyAlias &quot;release&quot;
            keyPassword &quot;7r00p3r5&quot;
        }
    }
    buildTypes {
        release {
            //...
            signingConfig signingConfigs.release
        }
    }
</code></pre>
<p>Maintenant, on peut voir la présence de la tâche qui nous intéresse : <code>publishApkRelease</code></p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_complete.png" data-lightbox="group-1" title="Liste des tasks gradle disponibles avec upload apk" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_tasks_config_complete.png" alt="Liste des tasks gradle disponibles avec upload apk"/>
  </a>
</div>        
<h2 id="étape-4--génération-et-upload">Étape 4 : génération et upload</h2>
<p>Pour effectuer un upload de l&rsquo;apk il suffit maintenant d&rsquo;appeler la tâche <code>publishApkRelease</code>. Et pas besoin de générer l&rsquo;apk signé via Android Studio puisque comme tout est configuré, il sera généré dans les tâches précédent l&rsquo;uploadApk.</p>
<p>Si tout se passe bien le build se termine avec un :</p>
<pre><code>BUILD SUCCESSFUL
</code></pre>
<p>Si il y a un problème lors de l&rsquo;updload, il est affiché dans la console, par exemple si le <strong>version code</strong> est déjà utilisé</p>
<div style="text-align:center;margin:50px">
  <a href="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_upload_ko.png" data-lightbox="group-1" title="Exemple d'upload d'apk en erreur" class="inlineBoxes">
    <img class="medium" src="/images/posts/2015-11-04-Android_publier_apk_avec_gradle/Android_Gradle_PublishAPK_Gradlew_upload_ko.png" alt="Exemple d'upload d'apk en erreur"/>
  </a>
</div>    
<p>Ensuite vous pouvez vous rendre sur l&rsquo;interface d&rsquo;admin du Play Store et constater que l&rsquo;upload d&rsquo;un nouvel apk a bien eu lieu en alpha et le passer en bêta ou en production.</p>
<p><strong>Attention</strong> : ne pas commiter la clé <code>JSON</code> sur github, au même titre que le mot de passe du <code>keystore</code>.</p>
<p>##Pour aller plus loin</p>
<p>Le plugin permet bien plus de choses que la livraison des apks. En effet, il permet de mettre à jour la description, les images et le changelog.
Pour savoir comment configurer tout cela, je vous invite à consulter la page github du projet <a href="https://github.com/Triple-T/gradle-play-publisher">https://github.com/Triple-T/gradle-play-publisher</a></p>
<p>L&rsquo;étape ultime de la livraison continue, c’est de configurer un jenkins pour qu’il livre en alpha à chaque nouveau commit sur master, et pour cela il suffit de le configurer en rajoutant par exemple une tâche post build qui fera appel à la commande gradle que nous venons de configurer.</p>

                    </div>
                    <div class="content-footer">
                        
                        <ul class="tags float">
                            
                            <li><a href="/tags/android/">Android</a></li>
                            
                            <li><a href="/tags/apk/">APK</a></li>
                            
                            <li><a href="/tags/gradle/">Gradle</a></li>
                            
                            <li><a href="/tags/livraison/">Livraison</a></li>
                            
                        </ul>
                        
                        <section id="author">
                            <div class="date">Rédigé par <span class="author-name">Florian</span></div>
                        </section>
                    </div>
                    <div class="share">
                        <span>Partager</span>
                        <ul class="socials">
                            <li>
                                <a target="_blank" title="Facebook"
                                   href="https://www.facebook.com/sharer.php?u=http://code-troopers.com%2f2015%2f11%2f04%2fandroid_publier_apk_avec_gradle%2f&t=Android%20%3a%20Publier%20son%20apk%20en%20ligne%20de%20commande"
                                   class="facebook-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                                    <i class="ri-facebook-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Twitter"
                                   href="https://twitter.com/share?url=http://code-troopers.com%2f2015%2f11%2f04%2fandroid_publier_apk_avec_gradle%2f&text=Android%20%3a%20Publier%20son%20apk%20en%20ligne%20de%20commande&via=codetroopers"
                                   rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                                    <i class="ri-twitter-x-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Google +"
                                   href="https://plus.google.com/share?url=http://code-troopers.com%2f2015%2f11%2f04%2fandroid_publier_apk_avec_gradle%2f&hl=fr"
                                   class="google-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                                    <i class="fa fa-google-plus"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div style="clear:both"></div>


                    <div class="back">
                        <div class="pagination">
                            
                            <a href="/2016/01/04/navigtours-cote_serveur/" class="previous-page">
                                <div class="arrow"><div class="arrow_box_left arrow_box">
</div></div>
                                Article précédent
                            </a>
                            
                            
                            <a href="/2015/09/30/newrelicdocker/" class="next-page">
                                Article suivant
                                <div class="arrow"><div class="arrow_box_right arrow_box">
</div></div>
                            </a>
                            
                        </div>
                    </div>

                    <section id="menu">
                        <ul>
                            
                        </ul>
                    </section>

                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                         
                        var disqus_shortname = 'codetroopers' 
                        var disqus_url = window.location.href
                        if (window.location.protocol != 'http:') {
                            disqus_url = 'http:' + window.location.href.substring(window.location.protocol.length)
                        }

                         
                        (function () {
                            var dsq = document.createElement('script')
                            dsq.type = 'text/javascript'
                            dsq.async = true
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
                        })()
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                        powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span
                            class="logo-disqus">Disqus</span></a>
                </div>
            </article>
        </div>
    </section>
</section>


    <section id="contact">
    <h1>Contact</h1>
    <div>
        <div>
            <img src="/img/legos_contact.webp" alt="legos" width="100%" height="100%">
        </div>
        <div>
            <h2>Code-Troopers</h2>
            <p>
                26 bis rue Abraham Bosse<br>
                37000 Tours - Fr
            </p>
            <p>
                <a href="mailto:contact@code-troopers.com">contact@code-troopers.com</a>
            </p>
            <p>
                <a class="button" href="tel:+33782287216">07 82 28 72 16</a>
            </p>
        </div>
    </div>

    <h1>Suivez nos actualités</h1>

    <ul class="flex">
        <li>
            <a aria-label="Facebook Code-Troopers" href="https://facebook.com/codetroopers37">
                <i class="ri-facebook-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a aria-label="Twitter Code-Troopers" href="https://twitter.com/codetroopers">
                <i class="ri-twitter-x-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a aria-label="Github Code-Troopers" href="https://github.com/code-troopers">
                <i class="ri-github-fill ri-3x"></i>
            </a>
        </li>
    </ul>
</section>

<footer>
    <div class="wrapper">
        <a href="#top" class="scroll-to-top">
            <img class="arrow" src="/img/arrow.png" alt="arrow">
        </a>
        <img src="/img/footer_logo.png" alt="logo">
        <div>
            <span>©2014 — 2024 Code-Troopers | <a href="/legals.html">Mentions légales</a></span>
            <span>Design : <a href="https://www.descheval.com/">descheval.com</a> | Développement : Code-Troopers</span>
        </div>
    </div>
</footer>

    
    
      <script src="/main.js"></script>
    
  </body>
</html>
