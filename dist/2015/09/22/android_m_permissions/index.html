<!doctype html>
<html lang="fr">
  <head>
  <title>Code-Troopers - Android M - Nouvelle gestion de permission</title>
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
/>

  
  
    <link href="/main.css" rel="stylesheet">
  
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <base href="/">
	
	<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
	<link rel="icon" href="/favicon.ico">
	<link rel="manifest" href="/manifest.json">
	<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#ff4400">
	<meta name="theme-color" content="#fff">

  
  <meta property="og:title" content="Android M - Nouvelle gestion de permission" />
<meta property="og:description" content="Nouvelle approche Avec la prochaine release d&rsquo;Android 6.0 Marshmallow, il va y avoir du changement au niveau de la gestion des permissions. Terminé la popup qui demande les 10 autorisations au moment du téléchargement de l&rsquo;appli, maintenant les développeurs vont pouvoir demander les permissions au moment où elles seront nécessaires.
Permissions irrévocables Puisqu&rsquo;il va falloir demander à l&rsquo;utilisateur pour chaque permission, Google a décidé que certaines anciennes permissions n&rsquo;auront plus besoin d&rsquo;être demandées, ce sont les Normal Permissions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2015/09/22/android_m_permissions/" /><meta property="og:image" content="/img/gopher_moi.png"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2015-09-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-09-22T00:00:00+00:00" />


  
</head>
  <body class="sans-serif">

    <header>
    <nav>
        
            <a id="id-company" href="/">Code-Troopers</a>
        
            <a id="id-skills" href="#skills">Compétences</a>
        
            <a id="id-portfolio" href="#portfolio">Réalisations</a>
        
            <a id="id-casting" href="https://team.code-troopers.com">L&#39;équipe</a>
        
            <a id="id-blogs" href="/blog">Blog</a>
        
            <a id="id-contact" href="#contact">Contact</a>
        
    </nav>
</header>

    

<section id="blog">
    <div class="wrapper">
        <h1>
            Blog
        </h1>
    </div>

    <section id="article">
        <div class="wrapper">
            <article>
                
                <img src="/blog/../androidPermission-banner.png">
                
                
                
                
                <div class="wrapper-content">
                    <h2>Android M - Nouvelle gestion de permission</h2>
                    
                    
                    <ul class="tags">
                        
                        <li><a href="/tags/android/">Android</a></li>
                        
                        <li><a href="/tags/permission/">Permission</a></li>
                        
                    </ul>
                    
                    <div class="content">
                        <h1 id="nouvelle-approche">Nouvelle approche</h1>
<p>Avec la prochaine release d&rsquo;<code>Android 6.0 Marshmallow</code>, il va y avoir du changement au niveau de la gestion des permissions.
Terminé la popup qui demande les 10 autorisations au moment du téléchargement de l&rsquo;appli, maintenant les développeurs vont pouvoir demander les permissions au moment où elles seront nécessaires.</p>
<h3 id="permissions-irrévocables">Permissions irrévocables</h3>
<p>Puisqu&rsquo;il va falloir demander à l&rsquo;utilisateur pour chaque permission, Google a décidé que certaines anciennes permissions n&rsquo;auront plus besoin d&rsquo;être demandées,
ce sont les <code>Normal Permissions</code>. Il s&rsquo;agit des permissions qui n&rsquo;engendrent pas de risque sur la vie privée ou sur la sécurité de l&rsquo;utilisateur comme c&rsquo;est par exemple le cas pour l&rsquo;accès à internet ou l&rsquo;accès au vibreur :
la liste complète est disponible <a href="https://developer.android.com/preview/features/runtime-permissions.html#normal">ici</a>.</p>
<h3 id="guidelines">Guidelines</h3>
<p>Pour ce qui est de l&rsquo;UX, Google a fait plusieurs recommandations dont certaines sont plus importantes que d&rsquo;autres, à mon avis :</p>
<ul>
<li>Ne demander une permisission qu&rsquo;au moment où l&rsquo;on en a vraiment besoin, ce qui implique de ne pas avoir un popup au lancement qui va demander toutes les permissions ;</li>
<li>Faire le maximum pour ne pas gâcher l&rsquo;experience utilisateur même s&rsquo;il refuse une permission : donc prévoir un mode dégradé autant que possible ;</li>
<li>Utiliser les méthodes disponibles dans appcompat plutôt que celles du sdk de base.</li>
</ul>
<h1 id="mise-en-pratique">Mise en pratique</h1>
<p>Avant de commencer à coder, une dernière chose à garder à l&rsquo;esprit c&rsquo;est que l&rsquo;utilisateur peut à tout moment révoquer une permission via le détail de l&rsquo;application (même une fois que l&rsquo;appli est lancée et tourne en background).
Il faudra donc adapter la gestion de ces permissions à cette éventualité.</p>
<div style="text-align:center;margin-bottom:50px">
    <a href="/images/posts/2015-09-AndroidMPermissions/p6.png" data-lightbox="group-1" title="Écran App Info" class="inlineBoxes">
        <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p6.png" alt="Écran App Info"/>
    </a>
    <a href="/images/posts/2015-09-AndroidMPermissions/p5.png" data-lightbox="group-1" title="Écran App Info : détail des permissions"  class="inlineBoxes">
            <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p5.png" alt="Écran App Info : détail des permissions"/>
    </a>
</div>
<h2 id="ne-pas-implémenter-les-nouvelles-permissions">Ne pas implémenter les nouvelles permissions</h2>
<p>Chose importante à savoir, vous n&rsquo;êtes pas obligés d&rsquo;implémenter cette nouvelle gestion de permission.
En effet, puisqu&rsquo;elle demande du développoment supplémentaire, de nombreuses applis ne seront pas mises à jour et garderont donc l&rsquo;ancien fonctionnement.
Si c&rsquo;est ce que vous souhaitez, et pour ne pas nuire au bon fonctionnement de votre appli, il vous suffit de ne pas cibler le dernier <code>sdk</code> dans votre build.gradle et de rester sur le <code>22</code>.</p>
<h2 id="implémenter-les-nouvelles-permissions">Implémenter les nouvelles permissions</h2>
<p>Pour cela, 3 étapes sont nécessaires, principalement disponibles dans le sdk 23 ainsi que dans la lib appcompat :</p>
<ul>
<li><code>requestPermissions()</code></li>
<li><code>onRequestPermissionsResult()</code></li>
<li><code>shouldShowRequestPermissionRationale()</code></li>
</ul>
<h3 id="buildgradle">Build.gradle</h3>
<p>Permière étape, cibler la dernier version du <code>sdk</code> : <code>23</code>.
Et en bonus, importer appcompat pour bénéficier des méthodes helpers de Google.</p>
<pre><code>compileSdkVersion 23
defaultConfig {
    targetSdkVersion 23
}
dependencies {
    compile 'com.android.support:appcompat-v7:23.0.1'
}
</code></pre>
<h3 id="androidmanifestxml">AndroidManifest.xml</h3>
<p>Ensuite, déclarer les permissions désirées dans l&rsquo;application, normalement il n&rsquo;y a pas de changements par rapport à votre configuration actuelle</p>
<pre><code>&lt;uses-permission android:name=&quot;android.permission.CAMERA&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.READ_CONTACTS&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.SEND_SMS&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.CALL_PHONE&quot; /&gt;
</code></pre>
<p>N&rsquo;oubliez pas d&rsquo;y déclarer aussi les <code>Normal Permissions</code> qui, bien qu&rsquo;elles soient automatiquement accordées, ont toujours besoin d&rsquo;être déclarées.</p>
<h3 id="dans-une-activité">Dans une activité</h3>
<p>Dans un premier temps il faut vérifier si une permission est déjà accordée ou non</p>
<pre><code>ContextCompat.checkSelfPermission(context, Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED;
</code></pre>
<p>Si la permission n&rsquo;est pas accordée, il va falloir la demander, de préférence lors d&rsquo;une action utilisateur, par exemple au click sur un bouton</p>
<pre><code>ActivityCompat.requestPermissions(MainActivity.this,
                                  new String[]{Manifest.permission.CAMERA},
                                  REQUEST_CODE_ONE);
</code></pre>
<div style="text-align:center;margin-bottom:50px">
    <a href="/images/posts/2015-09-AndroidMPermissions/p1.png" data-lightbox="group-1" title="Dialog de demande d'une permission" class="inlineBoxes">
        <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p1.png" alt="Dialog de demande d'une permission"/>
    </a>
</div>
<p>Puis écouter le choix de l&rsquo;utilisateur, dans l&rsquo;activité ou le fragment correspondant</p>
<pre><code>@Override
public void onRequestPermissionsResult(int requestCode, String permissions[], int[] grantResults) {
    switch (requestCode) {
        case REQUEST_CODE_ONE: {
            if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                Toast.makeText(this, &quot;Permission granted&quot;, Toast.LENGTH_LONG).show();
            } else {
                Toast.makeText(this, &quot;Permission denied&quot;, Toast.LENGTH_LONG).show();
            }
            return;
        }
    }
}
</code></pre>
<h3 id="demander-plusieurs-permissions-en-même-temps">Demander plusieurs permissions en même temps</h3>
<p>Même si cela est déconseillé, il peut arriver d&rsquo;avoir besoin de plusieurs permissions lors de la même action utilisateur.
Pour cela il suffit de passer plusieurs permissions dans le tableau passé en paramètre du requestPermission</p>
<pre><code>ActivityCompat.requestPermissions(MainActivity.this,
                                  new String[]{Manifest.permission.READ_CONTACTS, Manifest.permission.ACCESS_FINE_LOCATION},
                                  REQUEST_CODE_TWO);
</code></pre>
<div style="text-align:center;margin-bottom:50px">
    <a href="/images/posts/2015-09-AndroidMPermissions/p2.png" data-lightbox="group-1" title="Dialog de demande de plusieurs permissions 1/2" class="inlineBoxes">
        <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p2.png" alt="Dialog de demande de plusieurs permissions 1/2"/>
    </a>
<a href="/images/posts/2015-09-AndroidMPermissions/p3.png" data-lightbox="group-1" title="Dialog de demande de plusieurs permissions 2/2" class="inlineBoxes">
        <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p3.png" alt="Dialog de demande de plusieurs permissions 2/2"/>
    </a>
</div>
<h3 id="expliquer-à-lutilisateur-pourquoi-il-doit-autoriser-une-permission">Expliquer à l&rsquo;utilisateur pourquoi il doit autoriser une permission</h3>
<p>Il arrivera sûrement que certains utilsateurs refusent des permissions et que cela détériore l&rsquo;expérience utilisateur sur l&rsquo;application. Pour cela, Google fourni un helper pour savoir ou non s&rsquo;il faut afficher un message d&rsquo;information à l&rsquo;utilisateur (graphique).
Cela se fera avec la méthode shouldShowRequestPermissionRationale</p>
<pre><code>if (shouldShowRequestPermissionRationale(Manifest.permission.CALL_PHONE)) {
     new AlertDialog.Builder(MainActivity.this)
                               .setMessage(&quot;Custom message to explain why you need a permission&quot;)
                               .setPositiveButton(&quot;OK&quot;, new DialogInterface.OnClickListener() {
                                   @Override
                                   public void onClick(DialogInterface dialog, int which) {
                                       ActivityCompat.requestPermissions(MainActivity.this,
                                               new String[]{Manifest.permission.CALL_PHONE},
                                               REQUEST_CODE_FIVE);
                                   }
                               })
                               .setNegativeButton(&quot;Cancel&quot;, null)
                               .create()
                               .show();
}
ActivityCompat.requestPermissions(MainActivity.this,
                                  new String[]{Manifest.permission.CALL_PHONE},
                                  REQUEST_CODE_FIVE);
}
</code></pre>
<div style="text-align:center;margin-bottom:50px">
    <a href="/images/posts/2015-09-AndroidMPermissions/p4.png" data-lightbox="group-1" title="Dialog d'explication sur une demande de permissions" class="inlineBoxes">
        <img class="medium" src="/images/posts/2015-09-AndroidMPermissions/p4.png" alt="Dialog d'explication sur une demande de permissions"/>
    </a>
</div>
<h3 id="le-piège-à-éviter">Le piège à éviter</h3>
<p>Penser à vérifier régulièrement l&rsquo;état des permissions dans le <em>onResume()</em> de vos Activity ou Fragment, étant donné que l&rsquo;utilsateur peut à tout moment les révoquer cela permettra d&rsquo;éviter de nombreux crashs.</p>
<h2 id="resources">Resources</h2>
<p>Code source d&rsquo;exemple : <a href="https://github.com/fchauveau/android-permissions-sample">https://github.com/fchauveau/android-permissions-sample</a></p>
<p>Doc développeur Android : <a href="https://developer.android.com/preview/features/runtime-permissions.html">https://developer.android.com/preview/features/runtime-permissions.html</a></p>
<p>Guidelines Android : <a href="https://developer.android.com/preview/features/runtime-permissions.html">http://www.google.fr/design/spec/patterns/permissions.html</a></p>
<p>Explication sur quand demander une permission : <a href="https://www.youtube.com/watch?v=iZqDdvhTZj0">https://www.youtube.com/watch?v=iZqDdvhTZj0</a></p>

                    </div>
                    <div class="content-footer">
                        
                        <ul class="tags float">
                            
                            <li><a href="/tags/android/">Android</a></li>
                            
                            <li><a href="/tags/permission/">Permission</a></li>
                            
                        </ul>
                        
                        <section id="author">
                            <div class="date">Rédigé par <span class="author-name">Florian</span></div>
                        </section>
                    </div>
                    <div class="share">
                        <span>Partager</span>
                        <ul class="socials">
                            <li>
                                <a target="_blank" title="Facebook"
                                   href="https://www.facebook.com/sharer.php?u=http://code-troopers.com%2f2015%2f09%2f22%2fandroid_m_permissions%2f&t=Android%20M%20-%20Nouvelle%20gestion%20de%20permission"
                                   class="facebook-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                                    <i class="ri-facebook-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Twitter"
                                   href="https://twitter.com/share?url=http://code-troopers.com%2f2015%2f09%2f22%2fandroid_m_permissions%2f&text=Android%20M%20-%20Nouvelle%20gestion%20de%20permission&via=codetroopers"
                                   rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                                    <i class="ri-twitter-x-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Google +"
                                   href="https://plus.google.com/share?url=http://code-troopers.com%2f2015%2f09%2f22%2fandroid_m_permissions%2f&hl=fr"
                                   class="google-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                                    <i class="fa fa-google-plus"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div style="clear:both"></div>


                    <div class="back">
                        <div class="pagination">
                            
                            <a href="/2015/09/30/newrelicdocker/" class="previous-page">
                                <div class="arrow"><div class="arrow_box_left arrow_box">
</div></div>
                                Article précédent
                            </a>
                            
                            
                            <a href="/2015/09/09/ownclouddocker/" class="next-page">
                                Article suivant
                                <div class="arrow"><div class="arrow_box_right arrow_box">
</div></div>
                            </a>
                            
                        </div>
                    </div>

                    <section id="menu">
                        <ul>
                            
                        </ul>
                    </section>

                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                         
                        var disqus_shortname = 'codetroopers' 
                        var disqus_url = window.location.href
                        if (window.location.protocol != 'http:') {
                            disqus_url = 'http:' + window.location.href.substring(window.location.protocol.length)
                        }

                         
                        (function () {
                            var dsq = document.createElement('script')
                            dsq.type = 'text/javascript'
                            dsq.async = true
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
                        })()
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                        powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span
                            class="logo-disqus">Disqus</span></a>
                </div>
            </article>
        </div>
    </section>
</section>


    <section id="contact">
    <h1>Contact</h1>
    <div>
        <div>
            <img src="/img/legos_contact.webp" alt="legos" width="100%" height="100%">
        </div>
        <div>
            <h2>Code-Troopers</h2>
            <p>
                26 bis rue Abraham Bosse<br>
                37000 Tours - Fr
            </p>
            <p>
                <a href="mailto:contact@code-troopers.com">contact@code-troopers.com</a>
            </p>
            <p>
                <a class="button" href="tel:+33782287216">07 82 28 72 16</a>
            </p>
        </div>
    </div>

    <h1>Suivez nos actualités</h1>

    <ul class="flex">
        <li>
            <a href="https://facebook.com/codetroopers37">
                <i class="ri-facebook-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/codetroopers">
                <i class="ri-twitter-x-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/code-troopers">
                <i class="ri-github-fill ri-3x"></i>
            </a>
        </li>
    </ul>
</section>

<footer>
    <div class="wrapper">
        <a href="#top" class="scroll-to-top">
            <img class="arrow" src="/img/arrow.png" alt="arrow">
        </a>
        <img src="/img/footer_logo.png" alt="logo">
        <div>
            <span>©2014 — 2024 Code-Troopers | <a href="/legals.html">Mentions légales</a></span>
            <span>Design : <a href="https://www.descheval.com/">descheval.com</a> | Développement : Code-Troopers</span>
        </div>
    </div>
</footer>

    
    
      <script src="/main.js"></script>
    
  </body>
</html>
