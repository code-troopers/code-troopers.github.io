<!doctype html>
<html lang="fr">
  <head>
  <title>Code-Troopers - Résoudre les conflits de dépendances</title>
  <meta name="description" content="">
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
/>

  
  
    <link href="/main.8739a.css" rel="stylesheet">
  
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <base href="/">
	
	<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
	<link rel="icon" href="/favicon.ico">
	<link rel="manifest" href="/manifest.json">
	<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#ff4400">
	<meta name="theme-color" content="#fff">

  
  <meta property="og:title" content="Résoudre les conflits de dépendances" />
<meta property="og:description" content="Lors de nos développements, nous reposons beaucoup sur des projets externes qui nous fournissent énormément de services utiles. Dans un récent projet, nous avons eu besoin de faire fonctionner Neo4j conjointement à ElasticSearch. Jusqu&rsquo;ici, aucun soucis n&rsquo;est à déplorer, mais nous avions une exigence particulière : il fallait que l&rsquo;application puisse démarrer automatiquement un serveur Neo4J ainsi qu&rsquo;un serveur ElasticSearch sur les postes de développements (ainsi que pour les tests d&rsquo;intégration)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2014/09/01/conflitsdependances/" /><meta property="og:image" content="/img/logo-code-troopers-t%C3%AAte-couleur.png"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2014-09-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2014-09-01T00:00:00+00:00" />


  
</head>
  <body class="sans-serif">

    <header>
    <nav>
        
            <a id="id-company" href="/">Code-Troopers</a>
        
            <a id="id-skills" href="#skills">Compétences</a>
        
            <a id="id-portfolio" href="#portfolio">Réalisations</a>
        
            <a id="id-casting" href="https://team.code-troopers.com">L&#39;équipe</a>
        
            <a id="id-blogs" href="/blog">Blog</a>
        
            <a id="id-contact" href="#contact">Contact</a>
        
    </nav>
</header>

    

<section id="blog">
    <div class="wrapper">
        <h1>
            Blog
        </h1>
    </div>

    <section id="article">
        <div class="wrapper">
            <article>
                
                <img src="/blog/../maven-banner.png">
                
                
                
                
                <div class="wrapper-content">
                    <h2>Résoudre les conflits de dépendances</h2>
                    
                    
                    <ul class="tags">
                        
                        <li><a href="/tags/maven/">Maven</a></li>
                        
                        <li><a href="/tags/dependances/">Dependances</a></li>
                        
                        <li><a href="/tags/tips/">Tips</a></li>
                        
                    </ul>
                    
                    <div class="content">
                        <p>Lors de nos développements, nous reposons beaucoup sur des projets externes qui nous fournissent énormément de services
utiles. Dans un récent projet, nous avons eu besoin de faire fonctionner Neo4j conjointement à ElasticSearch. Jusqu&rsquo;ici,
aucun soucis n&rsquo;est à déplorer, mais nous avions une exigence particulière : il fallait que l&rsquo;application puisse
démarrer automatiquement un serveur Neo4J ainsi qu&rsquo;un serveur ElasticSearch sur les postes de développements (ainsi que
pour les tests d&rsquo;intégration).</p>
<h2 id="problème-existant">Problème existant</h2>
<p>Les deux outils que nous utilisons se basent sur Apache Lucene pour toute la partie indexation et accès aux données.
Mais, et c&rsquo;est là que le problème se situe, ils n&rsquo;utilisent pas les mêmes versions de Lucene.</p>
<pre><code>&lt;!-- Extrait du pom d'ElasticSearch --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;4.9.0&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<hr>
<pre><code>&lt;!-- Extrait du pom de Neo4j --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;3.6.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>ElasticSearch utilise la version 4.9.0, alors que Neo4J utilise la version 3.6.2. Ainsi, en fonction du bon vouloir du
<code>Classloader</code> qui sera utilisé par l&rsquo;application, il se peut qu&rsquo;ElasticSearch ou Neo4J refuse de fonctionner. La
difficulté pour comprendre et détecter le problème est qu&rsquo;il se manifeste souvent par un obscur <code>NoClassDefFoundError</code>
ou <code>NoSuchMethodError</code> qui n&rsquo;est pas des plus explicites (d&rsquo;autant plus lorsque notre IDE nous montre une version qui
contient ledit symbole non trouvé).</p>
<h2 id="solution-de-contournement">Solution de contournement</h2>
<p>Le conflit est assez simple à contourner une fois qu&rsquo;on a compris ce qui se passe. En fait, il y a deux classes portant
le même nom dans les classes chargées, par exemple <code>org.lucene.MaClass</code>, l&rsquo;une effaçant l&rsquo;autre aux yeux du
<code>ClassLoader</code>.
Une pratique courante est de renommer (ou relocate) le package de base d&rsquo;une bibliothèque utilisée et de l&rsquo;inclure dans
le fichier de package du projet, le plugin <code>maven-shade</code> est conçu dans cette optique.
Le choix fait est de renommer la dépendance Lucene dans Neo4J pour notre part, ainsi, nous avons forké le projet et
configuré le plugin <code>shade</code> pour qu&rsquo;il inclue le contenu de la dépendance d&rsquo;Apache Lucene et qu&rsquo;il fasse le renommage de
<code>org.apache.lucene</code> en <code>shaded.org.apache.lucene</code>.</p>
<pre><code> &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.2&lt;/version&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;phase&gt;package&lt;/phase&gt;
                &lt;goals&gt;
                    &lt;goal&gt;shade&lt;/goal&gt;
                &lt;/goals&gt;
                &lt;configuration&gt;
                    &lt;createDependencyReducedPom&gt;true&lt;/createDependencyReducedPom&gt;

                    &lt;artifactSet&gt;
                        &lt;includes&gt;
                            &lt;include&gt;org.apache.lucene:*&lt;/include&gt;
                        &lt;/includes&gt;
                    &lt;/artifactSet&gt;
                    &lt;relocations&gt;
                        &lt;relocation&gt;
                            &lt;pattern&gt;org.apache.lucene&lt;/pattern&gt;
                            &lt;shadedPattern&gt;shaded.org.apache.lucene&lt;/shadedPattern&gt;
                        &lt;/relocation&gt;
                    &lt;/relocations&gt;
                &lt;/configuration&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
  &lt;/plugin&gt;
</code></pre>
<h2 id="déploiement-et-nommage">Déploiement et nommage</h2>
<p>Pour ne pas polluer les dépôts, le numéro de version modifié a été postfixé par <code>-shaded</code>. Le déploiement a été fait sur
un dépôt Maven qui est en fait un simple repository Github.
Le commit correspondant à cette modification <a href="https://github.com/CedricGatay/neo4j/commit/452f58fca69ffe3b1d0eab6261b8342f8da95889">est consultable
ici</a>.</p>

                    </div>
                    <div class="content-footer">
                        
                        <ul class="tags float">
                            
                            <li><a href="/tags/maven/">Maven</a></li>
                            
                            <li><a href="/tags/dependances/">Dependances</a></li>
                            
                            <li><a href="/tags/tips/">Tips</a></li>
                            
                        </ul>
                        
                        <section id="author">
                            <div class="date">Rédigé par <span class="author-name">Cedric</span></div>
                        </section>
                    </div>
                    <div class="share">
                        <span>Partager</span>
                        <ul class="socials">
                            <li>
                                <a target="_blank" title="Facebook"
                                   href="https://www.facebook.com/sharer.php?u=http://code-troopers.com%2f2014%2f09%2f01%2fconflitsdependances%2f&t=R%c3%a9soudre%20les%20conflits%20de%20d%c3%a9pendances"
                                   class="facebook-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                                    <i class="ri-facebook-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Twitter"
                                   href="https://twitter.com/share?url=http://code-troopers.com%2f2014%2f09%2f01%2fconflitsdependances%2f&text=R%c3%a9soudre%20les%20conflits%20de%20d%c3%a9pendances&via=codetroopers"
                                   rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                                    <i class="ri-twitter-x-fill"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" title="Google +"
                                   href="https://plus.google.com/share?url=http://code-troopers.com%2f2014%2f09%2f01%2fconflitsdependances%2f&hl=fr"
                                   class="google-button" rel="nofollow"
                                   onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                                    <i class="fa fa-google-plus"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div style="clear:both"></div>


                    <div class="back">
                        <div class="pagination">
                            
                            <a href="/2014/09/04/addonsheroku/" class="previous-page">
                                <div class="arrow"><div class="arrow_box_left arrow_box">
</div></div>
                                Article précédent
                            </a>
                            
                            
                            <a href="/2014/08/08/elcurator/" class="next-page">
                                Article suivant
                                <div class="arrow"><div class="arrow_box_right arrow_box">
</div></div>
                            </a>
                            
                        </div>
                    </div>

                    <section id="menu">
                        <ul>
                            
                        </ul>
                    </section>

                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                         
                        var disqus_shortname = 'codetroopers' 
                        var disqus_url = window.location.href
                        if (window.location.protocol != 'http:') {
                            disqus_url = 'http:' + window.location.href.substring(window.location.protocol.length)
                        }

                         
                        (function () {
                            var dsq = document.createElement('script')
                            dsq.type = 'text/javascript'
                            dsq.async = true
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
                        })()
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                        powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span
                            class="logo-disqus">Disqus</span></a>
                </div>
            </article>
        </div>
    </section>
</section>


    <section id="contact">
    <h1>Contact</h1>
    <div>
        <div>
            <img src="/img/legos_contact.webp" alt="legos" width="100%" height="100%">
        </div>
        <div>
            <h2>Code-Troopers</h2>
            <p>
                26 bis rue Abraham Bosse<br>
                37000 Tours - Fr
            </p>
            <p>
                <a href="mailto:contact@code-troopers.com">contact@code-troopers.com</a>
            </p>
            <p>
                <a class="button" href="tel:+33782287216">07 82 28 72 16</a>
            </p>
        </div>
    </div>

    <h1>Suivez nos actualités</h1>

    <ul class="flex">
        <li>
            <a aria-label="Facebook Code-Troopers" href="https://facebook.com/codetroopers37">
                <i class="ri-facebook-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a aria-label="Twitter Code-Troopers" href="https://twitter.com/codetroopers">
                <i class="ri-twitter-x-fill ri-3x"></i>
            </a>
        </li>
        <li>
            <a aria-label="Github Code-Troopers" href="https://github.com/code-troopers">
                <i class="ri-github-fill ri-3x"></i>
            </a>
        </li>
    </ul>
</section>

<footer>
    <div class="wrapper">
        <a href="#top" class="scroll-to-top">
            <img class="arrow" src="/img/arrow.png" alt="arrow">
        </a>
        <img src="/img/footer_logo.png" alt="logo">
        <div>
            <span>©2014 — 2024 Code-Troopers | <a href="/legals.html">Mentions légales</a></span>
            <span>Design : <a href="https://www.descheval.com/">descheval.com</a> | Développement : Code-Troopers</span>
        </div>
    </div>
</footer>

    
    
      <script src="/main.8739a.js"></script>
    
  </body>
</html>
